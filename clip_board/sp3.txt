Option Explicit

Sub ExportTwoPageSets_ToPDF_ByReference()
    Const OUT_DIR As String = "C:\temp"
    Const MAXLEN As Long = 160
    Const CHUNK As Long = 2   ' size of each set (2 pages)

    Dim doc As Document
    Dim totalPages As Long, p As Long
    Dim startPg As Long, endPg As Long
    Dim refVal As String, baseName As String, finalName As String
    Dim sec As Section, hf As HeaderFooter
    Dim used As Object

    If Documents.Count = 0 Then
        MsgBox "Open a Word document first.", vbCritical: Exit Sub
    End If
    Set doc = ActiveDocument

    ' Ensure output folder
    On Error Resume Next
    If Dir(OUT_DIR, vbDirectory) = "" Then MkDir OUT_DIR
    On Error GoTo 0
    If Dir(OUT_DIR, vbDirectory) = "" Then
        MsgBox "Couldn't create/find " & OUT_DIR, vbCritical: Exit Sub
    End If

    Application.ScreenUpdating = False

    ' Remove ALL footers so page numbers don't render
    For Each sec In doc.Sections
        For Each hf In sec.Footers
            hf.Range.Delete
        Next hf
    Next sec

    totalPages = doc.ComputeStatistics(wdStatisticPages)
    Set used = CreateObject("Scripting.Dictionary")

    For p = 1 To totalPages Step CHUNK
        startPg = p
        endPg = IIf(p + CHUNK - 1 > totalPages, totalPages, p + CHUNK - 1)

        ' --- Get Reference from the FIRST page in this set ---
        refVal = ExtractReferenceFromPage(doc, startPg)
        If refVal = "" Then refVal = "UNKNOWN"
        refVal = CleanSeg(refVal)

        ' --- Build file name (your convention) ---
        baseName = "RuralOperationsDocuments_Remediation Communication_" & refVal & _
                   "_TDBreakCostIssue_" & refVal & _
                   "_Pages_" & CStr(startPg) & "-" & CStr(endPg)

        finalName = SanitizeFileName(baseName, MAXLEN)
        finalName = Dedupe(finalName, used)

        ' --- Export this 2-page (or last 1-page) set ---
        doc.ExportAsFixedFormat _
            OutputFileName:=OUT_DIR & "\" & finalName & ".pdf", _
            ExportFormat:=wdExportFormatPDF, _
            Range:=wdExportFromTo, From:=startPg, To:=endPg, _
            Item:=wdExportDocumentContent, _
            IncludeDocProps:=False, KeepIRM:=True, _
            CreateBookmarks:=wdExportCreateNoBookmarks, _
            DocStructureTags:=True, BitmapMissingFonts:=True, _
            UseISO19005_1:=False
    Next p

    Application.ScreenUpdating = True
    MsgBox "Done! Exported " & CStr(Int((totalPages + 1) / CHUNK)) & _
           " PDF(s) to " & OUT_DIR, vbInformation
End Sub

' ===== Helpers =====

Private Function ExtractReferenceFromPage(doc As Document, ByVal pageNo As Long) As String
    Dim r As Range, t As String
    Set r = doc.GoTo(What:=wdGoToPage, Which:=wdGoToAbsolute, Count:=pageNo)
    If pageNo = doc.ComputeStatistics(wdStatisticPages) Then
        r.End = doc.Range.End
    Else
        r.End = doc.GoTo(What:=wdGoToPage, Which:=wdGoToAbsolute, Count:=pageNo + 1).Start - 1
    End If
    t = r.Text

    ExtractReferenceFromPage = FindFirstMatch(t, "Reference\s*Number\s*[:#]?\s*([A-Za-z0-9\-\/]+)")
    If ExtractReferenceFromPage = "" Then _
        ExtractReferenceFromPage = FindFirstMatch(t, "Reference\s*No\.?\s*[:#]?\s*([A-Za-z0-9\-\/]+)")
    If ExtractReferenceFromPage = "" Then _
        ExtractReferenceFromPage = FindFirstMatch(t, "Reference\s*[:#]?\s*([A-Za-z0-9\-\/]+)")
    If ExtractReferenceFromPage = "" Then _
        ExtractReferenceFromPage = FindFirstMatch(t, "Incident\s*Number\s*[:#]?\s*([A-Za-z0-9\-\/]+)")
End Function

Private Function FindFirstMatch(ByVal text As String, ByVal pattern As String) As String
    Dim rx As Object, m As Object
    Set rx = CreateObject("VBScript.RegExp")
    With rx
        .Pattern = pattern
        .IgnoreCase = True
        .Global = False
        .MultiLine = True
    End With
    If rx.Test(text) Then
        Set m = rx.Execute(text)(0)
        FindFirstMatch = Trim$(m.SubMatches(0))
    Else
        FindFirstMatch = ""
    End If
End Function

Private Function CleanSeg(ByVal s As String) As String
    s = Trim$(s)
    s = Replace$(s, vbTab, " ")
    Do While Len(s) > 0 And InStr(" .,'""’”", Right$(s, 1)) > 0
        s = Left$(s, Len(s) - 1)
    Loop
    CleanSeg = s
End Function

Private Function SanitizeFileName(ByVal s As String, ByVal maxLen As Long) As String
    Dim bad As Variant, i As Long
    bad = Array("\", "/", ":", "*", "?", """", "<", ">", "|")
    For i = LBound(bad) To UBound(bad)
        s = Replace$(s, bad(i), "_")
    Next i
    s = Trim$(s)
    If Len(s) > maxLen Then s = Left$(s, maxLen)
    SanitizeFileName = s
End Function

Private Function Dedupe(ByVal base As String, ByVal used As Object) As String
    Dim key As String, n As Long
    key = LCase$(base)
    If Not used.Exists(key) Then
        used.Add key, 1
        Dedupe = base
    Else
        n = used(key) + 1
        used(key) = n
        Dedupe = base & "_" & n
    End If
End Function