import boto3
import os
import requests
from configparser import ConfigParser
from botocore.exceptions import ClientError

# Initialize config
config = ConfigParser()
config.read('/path/to/your/config.ini')  # Ensure this is the correct path for your Lambda setup

def get_smtp_password():
    try:
        # Initialize S3 client
        s3_client = boto3.client('s3')
        bucket_name = config.get('S3', 'bucket_name')

        # Read certificate paths from config.ini
        cert_file_path = config.get('CertPaths', 'cert_file')
        key_file_path = config.get('CertPaths', 'key_file')
        ca_cert_file_path = config.get('CertPaths', 'ca_cert_file')

        # Lambda's temporary directory for files
        temp_dir = "/tmp"

        # Download each certificate file from S3 to /tmp
        cert_files = {
            'cert_path': cert_file_path,
            'key_path': key_file_path,
            'ca_cert_path': ca_cert_file_path
        }
        local_paths = {}

        for config_key, s3_key in cert_files.items():
            local_path = os.path.join(temp_dir, os.path.basename(s3_key))
            try:
                # Download the certificate from S3 to the Lambda temp directory
                s3_client.download_file(bucket_name, s3_key, local_path)
                local_paths[config_key] = local_path
                print(f"Downloaded {s3_key} to {local_path}")
            except ClientError as e:
                print(f"Failed to download {s3_key} from S3: {e}")
                return None

        # Prepare API request config
        api_config = config['API']

        # Make the API request using the downloaded certificates
        response = requests.get(
            api_config['url'],
            params={
                'AppID': api_config['app_id'],
                'Safe': api_config['safe'],
                'UserName': api_config['username'],
                'Address': api_config['address']
            },
            cert=(local_paths['cert_path'], local_paths['key_path']),
            verify=local_paths['ca_cert_path'],
            timeout=30
        )

        if response.status_code == 200:
            return response.json().get('Content')
        else:
            print(f"Failed to get password. Status code: {response.status_code}")
            return None

    except Exception as e:
        print(f"Error retrieving password: {str(e)}")
        return None
